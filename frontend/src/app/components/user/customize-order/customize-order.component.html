<div class="co-wrapper">
  <div class="co-grid">
    <section class="card co-panel">
      <button class="btn-ghost back" type="button" (click)="goBack()">← Volver al menú</button>
      <h2 class="co-title">Personalizar pedido</h2>
      <p class="subtitle">Elige tamaño, toppings y revisa la disponibilidad antes de confirmar.</p>

      <div *ngIf="errorMsg" class="alert-error">{{ errorMsg }}</div>

      <div class="section">
        <div class="section-header">
          <div>
            <p class="eyebrow">Sabor base</p>
            <h3>{{ flavor?.nombre }}</h3>
          </div>
          <span class="stock" [class.out]="flavor?.cantidad_disponible === 0">
            {{ (flavor?.cantidad_disponible ?? 0) > 0 ? (flavor?.cantidad_disponible ?? 0) + ' en stock' : 'Agotado' }}
          </span>
        </div>
        <p class="muted" *ngIf="flavor?.descripcion">{{ flavor?.descripcion }}</p>
      </div>

      <div class="section">
        <div class="section-header">
          <div>
            <p class="eyebrow">Tamaño</p>
            <h4>Selecciona uno</h4>
          </div>
        </div>
        <div class="pill-grid">
          <button
            *ngFor="let s of sizes"
            type="button"
            class="pill"
            [class.active]="isSizeSelected(s)"
            [disabled]="s.cantidad_disponible <= 0"
            (click)="selectSize(s)"
          >
            <div class="pill-thumb">
              <img
                [src]="s.imagen_url || 'assets/images/placeholders/product-placeholder-1.webp'"
                [alt]="s.nombre"
              />
            </div>
            <div class="pill-content">
              <span class="pill-title">{{ s.nombre }}</span>
              <span class="pill-meta">{{ s.precio | number:'1.2-2' }} €</span>
              <small>
                {{ s.cantidad_disponible > 0 ? s.cantidad_disponible + ' disponibles' : 'Agotado' }}
              </small>
            </div>
          </button>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div>
            <p class="eyebrow">Toppings</p>
            <h4>Personaliza tu mezcla</h4>
          </div>
        </div>
        <div class="toppings-list">
          <label
            class="topping"
            *ngFor="let t of toppings"
            [class.disabled]="t.cantidad_disponible <= 0"
            [class.selected]="isToppingSelected(t)"
          >
            <input
              type="checkbox"
              [checked]="isToppingSelected(t)"
              [disabled]="t.cantidad_disponible <= 0"
              (change)="toggleToppingSelection(t)"
            />

            <div class="topping-thumb">
              <img
                [src]="t.imagen_url || 'assets/images/placeholders/product-placeholder-1.webp'"
                [alt]="t.nombre"
              />
            </div>

            <div class="topping-info">
              <div class="name">{{ t.nombre }}</div>
              <div class="meta">
                {{ t.precio | number:'1.2-2' }} €
                · {{ t.cantidad_disponible > 0 ? 'Disponible' : 'Agotado' }}
              </div>
            </div>
          </label>
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="button" (click)="addToCart()">Añadir al pedido</button>
      </div>
    </section>

    <aside class="card co-summary">
      <div class="summary-image">
        <img [src]="flavor?.imagen_url || 'assets/images/placeholders/product-placeholder-1.webp'" [alt]="flavor?.nombre || 'Yogur helado'" />
      </div>
      <div class="summary-body">
        <p class="eyebrow">Resumen</p>
        <h3>{{ flavor?.nombre }}</h3>
        <div class="summary-row">
          <span class="label">Tamaño</span>
          <span class="value">{{ selectedSize?.nombre || 'Sin seleccionar' }}</span>
        </div>
        <div class="summary-row">
          <span class="label">Toppings</span>
          <span class="value">{{ selectedToppingsLabel }}</span>
        </div>
        <div class="summary-row total">
          <span>Total estimado</span>
          <strong>
            {{ totalEstimate | number:'1.2-2' }} €
          </strong>
        </div>
      </div>
    </aside>
  </div>
</div>
